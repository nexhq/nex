---
import Layout from '../../layouts/Layout.astro';

import fs from 'node:fs';
import path from 'node:path';

export async function getStaticPaths() {
  const registryUrl = 'http://localhost:5000/api/packages';
  let packages = [];
  
  try {
    const response = await fetch(registryUrl);
    if (response.ok) {
      const data = await response.json();
      packages = data.packages || [];
    }
  } catch (e) {
    console.warn("Failed to load registry index for static paths from API", e);
    packages = [];
  }
  
  return packages.map((pkg: any) => ({
    params: { id: pkg.id },
    props: { pkg }
  }));
}


const { id } = Astro.params;
const initialPkg = (Astro.props as any).pkg;

const manifestUrl = `http://localhost:5000/api/packages/${id}`;
let manifest = null;
let versionHistory: any[] = [];
let dependencyList: any[] = [];

const siteBase = import.meta.env.BASE_URL || '/';

try {
    const response = await fetch(manifestUrl);
    if (response.ok) {
        manifest = await response.json();
    } else {
        throw new Error(`Failed to fetch manifest: ${response.status}`);
    }
} catch (e) {
  console.warn(`Error loading manifest for ${id}, using fallback data.`);
  // Fallback to initial data if available
  manifest = {
    id: initialPkg.id,
    name: initialPkg.name,
    version: initialPkg.version,
    description: initialPkg.description,
    author: initialPkg.author || { name: 'Unknown' },
    keywords: initialPkg.keywords || [],
    repository: initialPkg.repository,
    ...initialPkg
  };
}

// Version history
// Version history
versionHistory = manifest.versions || [];

if (!versionHistory || versionHistory.length === 0) {
  versionHistory = [
    {
      version: manifest.version,
      date: manifest.publishedAt || manifest.updatedAt || '',
      changelog: manifest.changelog || 'Latest release'
    }
  ];
}

// Dependencies
if (Array.isArray(manifest.dependencies)) {
  dependencyList = manifest.dependencies;
} else if (manifest.dependencies && typeof manifest.dependencies === 'object') {
  dependencyList = Object.entries(manifest.dependencies).map(([dep, ver]) => ({ id: dep, version: ver }));
}
---

<Layout title={`${manifest.name} | nex`} description={manifest.description}>
  <div class="package-header">
    <div class="container">
      <div class="header-top">
        <h1>{manifest.name}</h1>
        <span class="version-tag">v{manifest.version}</span>
        {manifest.license && <span class="license-tag">{manifest.license}</span>}
      </div>
      <p class="package-description">{manifest.description}</p>
      
      <div class="package-tabs">
        <button class="tab active" data-target="readme">Readme</button>
        <button class="tab" data-target="dependencies">Dependencies</button>
        <button class="tab" data-target="versions">Versions</button>
      </div>
    </div>
  </div>

  <main class="container">
    <div class="package-layout">
      <div class="main-column">
        <div class="main-content-wrapper">
          <div id="tab-readme" class="tab-content active">
            <section class="quick-start-section">
              <div class="quick-start-card">
                <div class="qs-left">
                  <div class="qs-label-row">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" class="qs-icon">
                      <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
                    </svg>
                    <h3>Quick Start</h3>
                  </div>
                  <p>Run instantly with nex:</p>
                </div>
                <div class="qs-right">
                  <div class="qs-cmd">
                    <span class="qs-prompt">$</span>
                    <code>nex run {manifest.name.toLowerCase()}</code>
                  </div>
                  <button class="copy-icon-btn qs-copy" data-copy={`nex run ${manifest.name.toLowerCase()}`} title="Copy run command">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <rect x="9" y="9" width="13" height="13" rx="2"/>
                      <path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/>
                    </svg>
                  </button>
                </div>
              </div>
            </section>

            {manifest.screenshots && manifest.screenshots.length > 0 && (
              <section class="screenshots-section">
                <h2>Preview</h2>
                <div class="screenshots-grid">
                  {manifest.screenshots.map((s: any) => (
                    <figure class="screenshot-item">
                      <img src={s.url} alt={s.caption || 'Package screenshot'} loading="lazy" />
                      {s.caption && <figcaption>{s.caption}</figcaption>}
                    </figure>
                  ))}
                </div>
              </section>
            )}
  
            {manifest.commands && Object.keys(manifest.commands).length > 0 && (
              <section class="markdown-section">
                <h2>Available Commands</h2>
                <div class="commands-table">
                  <table>
                    <thead>
                      <tr>
                        <th>Command</th>
                        <th>Runs</th>
                      </tr>
                    </thead>
                    <tbody>
                      {Object.entries(manifest.commands).map(([name, cmd]) => (
                        <tr>
                          <td><code>nex run {manifest.name.toLowerCase()} {name === 'default' ? '' : name}</code></td>
                          <td><code class="cmd-value">{cmd}</code></td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </section>
            )}
  
            {manifest.keywords && manifest.keywords.length > 0 && (
              <section class="markdown-section">
                <h2>Keywords</h2>
                <div class="keywords-list">
                  {manifest.keywords.map((kw: string) => (
                    <span class="keyword-tag">{kw}</span>
                  ))}
                </div>
              </section>
            )}
          </div>

          <div id="tab-versions" class="tab-content" style="display: none;">
            {versionHistory && versionHistory.length > 0 ? (
              <section class="markdown-section">
                <h2>Version History</h2>
                <div class="versions-list">
                  {versionHistory.map((v) => (
                    <div class="version-item">
                      <div>
                        <div class="version-label">v{v.version}</div>
                        {v.date && <div class="version-date">{v.date}</div>}
                        {v.changelog && <p class="version-notes">{v.changelog}</p>}
                      </div>
                      <div class="version-actions">
                        <button class="copy-btn" data-copy={`nex install ${manifest.name.toLowerCase()}@${v.version}`} title="Copy install command">
                          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="9" y="9" width="13" height="13" rx="2"/>
                            <path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/>
                          </svg>
                        </button>
                      </div>
                    </div>
                  ))}
                </div>
              </section>
            ) : (
                <p class="empty-text">No version history available.</p>
            )}
          </div>

          <div id="tab-dependencies" class="tab-content" style="display: none;">
            {dependencyList && dependencyList.length > 0 ? (
              <section class="markdown-section">
                <h2>Dependencies</h2>
                <div class="dependency-graph">
                  {dependencyList.map((dep) => (
                    <div class="dependency-node">
                      <div class="dep-line"></div>
                      <div class="dep-card">
                        <div class="dep-name">{dep.id || dep.name}</div>
                        {dep.version && <div class="dep-version">{dep.version}</div>}
                        {dep.type && <span class="dep-tag">{dep.type}</span>}
                      </div>
                    </div>
                  ))}
                </div>
              </section>
            ) : (
                <p class="empty-text">No dependencies.</p>
            )}
          </div>
        </div>
      </div>

      <aside class="sidebar-column">
        <div class="sidebar-block">
          <h3>Install</h3>
          <div class="install-cmd-box">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="cmd-icon">
              <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
            </svg>
            <code>nex install {manifest.name.toLowerCase()}</code>
            <button class="copy-icon-btn" data-copy={`nex install ${manifest.name.toLowerCase()}`} title="Copy to clipboard">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="9" y="9" width="13" height="13" rx="2"/>
                <path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/>
              </svg>
            </button>
          </div>
        </div>

        <div class="sidebar-block">
          <h3>Resources</h3>
          <div class="resource-links">
            {manifest.funding && (
              <a href={manifest.funding} target="_blank" rel="noopener" class="sponsor-btn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                </svg>
                <span>Sponsor</span>
              </a>
            )}
            {manifest.repository && (
              <a href={manifest.repository} target="_blank" rel="noopener" class="resource-link">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0024 12c0-6.63-5.37-12-12-12z"/>
                </svg>
                <span>Repository</span>
              </a>
            )}
            
            {manifest.repository && manifest.repository.includes('github.com') && (
              <a href={`${manifest.repository.replace(/\.git$/, '')}/issues`} target="_blank" rel="noopener" class="resource-link">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"></circle>
                  <line x1="12" y1="8" x2="12" y2="12"></line>
                  <line x1="12" y1="16" x2="12.01" y2="16"></line>
                </svg>
                <span>Issues</span>
              </a>
            )}
            
            {manifest.homepage && (
              <a href={manifest.homepage} target="_blank" rel="noopener" class="resource-link">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                  <polyline points="15 3 21 3 21 9"></polyline>
                  <line x1="10" y1="14" x2="21" y2="3"></line>
                </svg>
                <span>Homepage</span>
              </a>
            )}
          </div>
        </div>

        <div class="sidebar-block" id="github-stats-block" style="display: none;" data-repo={manifest.repository}>
          <h3>GitHub Stats</h3>
          <div class="stats-grid">
            <div class="stat-item" title="Stars">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
              </svg>
              <span id="gh-stars">--</span>
            </div>
            <div class="stat-item" title="Forks">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="6" y1="3" x2="6" y2="15"></line>
                <circle cx="18" cy="6" r="3"></circle>
                <circle cx="6" cy="18" r="3"></circle>
                <path d="M18 9a9 9 0 0 1-9 9"></path>
              </svg>
              <span id="gh-forks">--</span>
            </div>
          </div>
        </div>

        <div class="sidebar-block">
          <h3>Details</h3>
          <div class="sidebar-info">
            {manifest.author && (
              <div class="info-item">
                <span class="label">Author</span>
                <span class="value">
                  {typeof manifest.author === 'string' ? manifest.author : (
                    manifest.author.github ? (
                      <a href={`https://github.com/${manifest.author.github}`} target="_blank" rel="noopener">
                        {manifest.author.name || manifest.author.github}
                      </a>
                    ) : manifest.author.name
                  )}
                </span>
              </div>
            )}
            
            <div class="info-item">
              <span class="label">Version</span>
              <span class="value">{manifest.version}</span>
            </div>

            {manifest.license && (
              <div class="info-item">
                <span class="label">License</span>
                <span class="value">{manifest.license}</span>
              </div>
            )}

            {manifest.runtime && (
              <div class="info-item">
                <span class="label">Runtime</span>
                <span class="value">{manifest.runtime.type} {manifest.runtime.version}</span>
              </div>
            )}
          </div>
        </div>

        {manifest.platforms && (
          <div class="sidebar-block">
            <h3>Platforms</h3>
            <div class="platforms-list">
              {manifest.platforms.map((p: string) => (
                <span class="platform-tag">{p}</span>
              ))}
            </div>
          </div>
        )}
      </aside>
    </div>
  </main>
</Layout>

<style>
  :root {
    --bg-main: #ffffff;      
    --bg-surface: #fafafa;   /* Zinc 50 */
    --bg-card: #ffffff;
    --border: #e4e4e7;       /* Zinc 200 */
    --text-primary: #18181b; /* Zinc 900 */
    --text-secondary: #71717a; /* Zinc 500 */
    --accent: #e11d48;       /* Rose 600 */
    --accent-glow: rgba(225, 29, 72, 0.1);
    --font-mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  }

  /* Global Reset & Base */
  body {
    background-color: var(--bg-main);
    color: var(--text-primary);
  }

  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 1.5rem;
  }

  /* --- Hero Header --- */
  .package-header {
    background: radial-gradient(circle at top center, #fff1f2 0%, #ffffff 70%);
    border-bottom: 1px solid var(--border);
    padding: 4rem 0 2rem;
    position: relative;
    overflow: hidden;
  }
  
  /* Subtle mesh effect overlay (lighter) */
  .package-header::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    background-image: 
      linear-gradient(rgba(0, 0, 0, 0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0, 0, 0, 0.03) 1px, transparent 1px);
    background-size: 40px 40px;
    mask-image: linear-gradient(to bottom, black 40%, transparent 100%);
    pointer-events: none;
  }

  .header-top {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
    position: relative;
    z-index: 1;
  }

  .header-top h1 {
    font-size: 2.5rem;
    font-weight: 800;
    letter-spacing: -0.02em;
    color: var(--text-primary);
    background: none;
    -webkit-text-fill-color: initial;
    margin: 0;
  }

  .version-tag {
    background: #fff;
    border: 1px solid var(--border);
    color: var(--accent);
    font-family: var(--font-mono);
    font-size: 0.85rem;
    padding: 0.2rem 0.6rem;
    border-radius: 6px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
  }

  .license-tag {
    font-size: 0.8rem;
    color: var(--text-secondary);
    border: 1px solid var(--border);
    padding: 0.2rem 0.6rem;
    border-radius: 99px;
    background: #fff;
  }

  .package-description {
    font-size: 1.125rem;
    line-height: 1.6;
    color: var(--text-secondary);
    max-width: 700px;
    margin-bottom: 2.5rem;
    position: relative;
    z-index: 1;
  }

  /* --- Tabs --- */
  .package-tabs {
    display: flex;
    gap: 0.5rem;
    position: relative;
    z-index: 1;
  }

  .tab {
    text-decoration: none;
    color: var(--text-secondary);
    padding: 0.75rem 1.25rem;
    font-size: 0.95rem;
    font-weight: 500;
    border-radius: 8px 8px 0 0;
    border-bottom: 2px solid transparent;
    transition: all 0.2s ease;
    background: transparent;
    border: none;
    cursor: pointer;
    font-family: inherit;
  }

  .tab:hover {
    color: var(--text-primary);
    background: var(--bg-surface);
  }

  .tab.active {
    color: var(--accent);
    border-bottom-color: var(--accent);
    background: linear-gradient(to top, rgba(225, 29, 72, 0.05), transparent);
  }

  /* --- Main Layout --- */
  .package-layout {
    display: grid;
    grid-template-columns: minmax(0, 1fr) 320px;
    gap: 3rem;
    padding: 3rem 0;
  }


  /* --- Content Sections --- */
  /* Quick Start Card */
  .quick-start-section {
    margin-bottom: 3rem;
  }

  .quick-start-card {
    background: linear-gradient(135deg, #fff1f2 0%, #ffffff 100%);
    border: 1px solid #fecdd3; /* Rose 200 */
    border-radius: 16px;
    padding: 1.5rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 2rem;
    box-shadow: 0 10px 30px -5px rgba(225, 29, 72, 0.1);
    position: relative;
    overflow: hidden;
  }

  .quick-start-card::after {
    content: '';
    position: absolute;
    top: 0; right: 0; bottom: 0; width: 4px;
    background: var(--accent);
    opacity: 0.5;
  }

  .qs-left {
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
    min-width: 180px;
  }

  .qs-label-row {
    display: flex;
    align-items: center;
    gap: 0.6rem;
    color: var(--accent);
  }

  .qs-label-row h3 {
    margin: 0;
    font-size: 1.15rem;
    font-weight: 700;
  }

  .qs-left p {
    margin: 0;
    font-size: 0.9rem;
    color: #71717a;
  }

  .qs-right {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    background: #ffffff;
    border: 1px solid #e4e4e7;
    padding: 0.75rem 1rem;
    border-radius: 10px;
    flex: 1;
    max-width: 450px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.03);
  }

  .qs-cmd {
    flex: 1;
    font-family: var(--font-mono);
    font-size: 1rem;
    color: #18181b;
    display: flex;
    gap: 0.6rem;
    align-items: center;
    overflow: hidden;
  }

  .qs-prompt {
    color: #d4d4d8;
    user-select: none;
    font-weight: 600;
  }
  
  .qs-cmd code {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .qs-copy {
    background: #f4f4f5;
    border: none;
    color: #52525b;
    padding: 6px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
  }
  
  .qs-copy:hover {
    background: var(--accent);
    color: #fff;
  }

  @media (max-width: 768px) {
    .quick-start-card {
      flex-direction: column;
      align-items: flex-start;
      gap: 1rem;
    }
    .qs-right {
      width: 100%;
      max-width: none;
    }
  }

  .markdown-section {
    margin-bottom: 3rem;
  }

  .markdown-section h2 {
    font-size: 1.5rem;
    color: var(--text-primary);
    margin-bottom: 1.5rem;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid var(--border);
  }

  /* Code Blocks (Command Runner) */
  .code-block {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 20px rgba(0,0,0,0.2);
  }

  .code-header {
    background: var(--bg-surface);
    border-bottom: 1px solid var(--border);
    padding: 0.75rem 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .code-header span {
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-secondary);
    font-weight: 600;
  }

  .code-block pre {
    margin: 0;
    padding: 1.25rem;
    overflow-x: auto;
    background: transparent;
  }

  .code-block code {
    font-family: var(--font-mono);
    color: #a5b4fc; /* Light Indigo */
    font-size: 0.95rem;
  }

  /* --- Sidebar --- */
  .sidebar-column {
    position: sticky;
    top: 2rem;
    height: fit-content;
  }

  .sidebar-block {
    background: var(--bg-surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 1.25rem;
    margin-bottom: 1.5rem;
  }

  .sidebar-block h3 {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-secondary);
    margin-bottom: 1rem;
  }

  /* Install Box */
  .install-cmd-box {
    background: #000;
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 0.75rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-family: var(--font-mono);
    font-size: 0.85rem;
    color: var(--accent);
    transition: border-color 0.2s;
  }

  .install-cmd-box:hover {
    border-color: var(--accent);
    box-shadow: 0 0 0 1px var(--accent-glow);
  }

  .cmd-icon {
    width: 16px; height: 16px;
    opacity: 0.7;
  }

  .install-cmd-box code {
    flex: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  /* Copy Button */
  .copy-icon-btn, .copy-btn {
    background: transparent;
    border: 1px solid var(--border);
    color: var(--text-secondary);
    border-radius: 6px;
    padding: 4px;
    cursor: pointer;
    transition: all 0.2s;
    display: flex; align-items: center; justify-content: center;
  }

  .copy-icon-btn:hover, .copy-btn:hover {
    background: var(--bg-surface);
    color: var(--text-primary);
    border-color: var(--text-secondary);
  }

  /* Links */
  .sidebar-link {
    color: var(--text-primary);
    text-decoration: none;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0;
    transition: color 0.2s;
  }

  .sidebar-link:hover {
    color: var(--accent);
  }

  /* Dependency Graph */
  .dependency-graph {
    display: grid;
    gap: 1rem;
  }

  .dependency-node {
    display: grid;
    grid-template-columns: 20px 1fr;
    gap: 1rem;
    align-items: center;
  }

  .dep-line {
    width: 2px;
    height: 100%;
    background: var(--border);
    position: relative;
    left: 9px;
  }
  
  .dep-node::before {
    /* Dot */
    content: '';
    width: 10px; height: 10px;
    background: var(--border);
    border-radius: 50%;
  }

  .dep-card {
    background: var(--bg-surface);
    border: 1px solid var(--border);
    padding: 1rem;
    border-radius: 8px;
  }

  /* Responsive */
  /* Screenshots */
  .screenshots-grid {
    display: grid;
    gap: 1.5rem;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  }
  
  .screenshot-item {
    margin: 0;
    border: 1px solid var(--border);
    border-radius: 10px;
    overflow: hidden;
    background: #000;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  }
  
  .screenshot-item img {
    width: 100%;
    height: auto;
    display: block;
  }
  
  .screenshot-item figcaption {
    padding: 0.5rem 0.75rem;
    font-size: 0.85rem;
    color: var(--text-secondary);
    background: var(--bg-surface);
    border-top: 1px solid var(--border);
    text-align: center;
  }
  
  /* Sponsor Button */
  .sponsor-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    width: 100%;
    padding: 0.6rem;
    border-radius: 8px;
    background: #fdf2f8; /* Pink 50 */
    color: #db2777; /* Pink 600 */
    border: 1px solid #fbcfe8;
    font-weight: 600;
    text-decoration: none;
    transition: all 0.2s;
    margin-bottom: 0.75rem;
  }
  
  .sponsor-btn:hover {
    background: #fce7f3;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px -2px rgba(219, 39, 119, 0.2);
  }
  
  .sponsor-btn svg {
    fill: currentColor;
    color: #db2777;
  }

  /* Sidebar Resources */
  .resource-links {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }
  
  .resource-link {
    display: flex;
    align-items: center;
    gap: 0.6rem;
    padding: 0.5rem;
    color: var(--text-secondary);
    text-decoration: none;
    border-radius: 6px;
    transition: all 0.2s;
    font-size: 0.9rem;
  }
  
  .resource-link:hover {
    background: var(--bg-main);
    color: var(--accent);
  }
  
  /* GitHub Stats */
  .stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.75rem;
  }
  
  .stat-item {
    background: var(--bg-main);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 0.5rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.25rem;
  }
  
  .stat-value {
    font-weight: 700;
    color: var(--text-primary);
    font-size: 1.1rem;
  }
  
  .stat-item svg {
    color: var(--text-secondary);
    width: 14px; height: 14px;
    margin-bottom: 2px;
  }
  
  @media (max-width: 768px) {
    .package-layout { grid-template-columns: 1fr; }
    .sidebar-column { position: static; order: -1; }
    .header-top h1 { font-size: 1.75rem; }
  }
</style>

<script>
  const copyToClipboard = async (btn: HTMLElement) => {
    const text = btn.dataset.copy;
    if (text) {
      try {
        await navigator.clipboard.writeText(text);
        const svg = btn.querySelector('svg');
        const original = svg ? svg.innerHTML : null;
        const originalText = btn.textContent;

        if (svg) {
          svg.innerHTML = '<path d="M20 6L9 17l-5-5" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>';
        } else {
          btn.textContent = 'Copied!';
        }

        btn.classList.add('copied');
        setTimeout(() => {
          if (svg && original !== null) svg.innerHTML = original;
          if (!svg && originalText) btn.textContent = originalText;
          btn.classList.remove('copied');
        }, 1500);
      } catch (err) {
        console.error('Failed to copy:', err);
      }
    }
  };

  document.querySelectorAll('.copy-btn, .copy-icon-btn').forEach(btn => {
    btn.addEventListener('click', () => copyToClipboard(btn as HTMLElement));
  });

  // Tab Switching Logic
  const tabs = document.querySelectorAll('.tab');
  const contents = document.querySelectorAll('.tab-content');

  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      tabs.forEach(t => t.classList.remove('active'));
      tab.classList.add('active');

      const target = (tab as HTMLElement).dataset.target;
      contents.forEach(content => {
        (content as HTMLElement).style.display = content.id === `tab-${target}` ? 'block' : 'none';
      });
    });
  });

  // Simple canvas bar chart for downloads
  const chartEl = document.getElementById('download-chart') as HTMLCanvasElement;
  if (chartEl) {
    const ctx = chartEl.getContext('2d');
    const series = JSON.parse(chartEl.dataset.series || '[]');
    if (ctx && series.length) {
      const padding = 32;
      const width = chartEl.width - padding * 2;
      const height = chartEl.height - padding * 2;
      const max = Math.max(...series.map((s: any) => s.count));
      const barWidth = width / series.length - 12;

      ctx.clearRect(0, 0, chartEl.width, chartEl.height);
      ctx.fillStyle = '#0f0f0f';
      ctx.fillRect(0, 0, chartEl.width, chartEl.height);

      series.forEach((s: any, idx: number) => {
        const x = padding + idx * (barWidth + 12);
        const barHeight = max ? (s.count / max) * height : 0;
        const y = chartEl.height - padding - barHeight;
        ctx.fillStyle = '#cb3837';
        ctx.fillRect(x, y, barWidth, barHeight);
        ctx.fillStyle = '#ccc';
        ctx.font = '10px monospace';
        ctx.fillText(s.date || '', x, chartEl.height - padding + 12);
      });
    }
  }
  // Fetch GitHub Stats
  const statsBlock = document.getElementById('github-stats-block');
  if (statsBlock && statsBlock.dataset.repo) {
    const repoUrl = statsBlock.dataset.repo;
    if (repoUrl.includes('github.com')) {
      const match = repoUrl.match(/github\.com\/([^/]+)\/([^/]+)/);
      if (match) {
        const [_, owner, repo] = match;
        // Clean repo name from .git suffix
        const cleanRepo = repo.replace(/\.git$/, '');
        const api = `https://api.github.com/repos/${owner}/${cleanRepo}`;
        
        fetch(api)
          .then(res => res.json())
          .then(data => {
            if (data.stargazers_count !== undefined) {
              const starsEl = document.getElementById('gh-stars');
              const forksEl = document.getElementById('gh-forks');
              if (starsEl) starsEl.textContent = kFormatter(data.stargazers_count);
              if (forksEl) forksEl.textContent = kFormatter(data.forks_count);
              statsBlock.style.display = 'block';
            }
          })
          .catch(console.error);
      }
    }
  }

  function kFormatter(num: any) {
      const n = Number(num);
      return Math.abs(n) > 999 
        ? (Math.sign(n)*((Math.abs(n)/1000).toFixed(1))) + 'k' 
        : Math.sign(n)*Math.abs(n)
  }
</script>
