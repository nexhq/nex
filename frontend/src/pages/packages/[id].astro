---
import Layout from '../../layouts/Layout.astro';

export async function getStaticPaths() {
  const registryUrl = 'https://raw.githubusercontent.com/devkiraa/nex/main/registry/index.json';
  let packages = [];
  
  try {
    if (import.meta.env.DEV) {
      packages = [
        {
          id: 'devkiraa.pagepull',
          name: 'PagePull',
          version: '1.0.0',
          description: 'Extract web pages as clean Markdown for AI/LLM consumption',
          keywords: ['web', 'scraper', 'markdown', 'ai', 'llm'],
          manifest: 'packages/d/devkiraa/pagepull/manifest.json'
        }
      ];
    } else {
      const response = await fetch(registryUrl);
      const data = await response.json();
      packages = data.packages || [];
    }
  } catch (e) {
    packages = [];
  }
  
  return packages.map((pkg: any) => ({
    params: { id: pkg.id },
    props: { pkg }
  }));
}

const { id } = Astro.params;
const pkg = (Astro.props as any).pkg;

const manifestUrl = `https://raw.githubusercontent.com/devkiraa/nex/main/registry/${pkg.manifest}`;
let manifest = null;
let versionHistory: any[] = [];
let dependencyList: any[] = [];

const siteBase = import.meta.env.BASE_URL || '/';

try {
  if (import.meta.env.DEV) {
    manifest = {
      id: pkg.id,
      name: pkg.name,
      version: pkg.version,
      description: pkg.description,
      author: { name: 'DevKira', github: 'devkiraa' },
      license: 'MIT',
      repository: 'https://github.com/devkiraa/pagepull',
      runtime: { type: 'python', version: '>=3.10' },
      entrypoint: 'main.py',
      commands: {
        default: 'python main.py',
        'export': 'python main.py export',
        help: 'python main.py --help'
      },
      keywords: pkg.keywords,
      platforms: ['windows', 'linux', 'macos'],
      dependencies: [
        { id: 'python', version: '>=3.10', type: 'runtime' },
        { id: 'requests', version: '^2.31.0', type: 'library' }
      ],
      versions: [
        { version: '1.0.0', date: '2023-10-25', changelog: 'Initial release.' }
      ]
    };
  } else {
    const response = await fetch(manifestUrl);
    manifest = await response.json();
  }
} catch (e) {
  manifest = pkg;
}

// Version history
const versionsUrl = manifestUrl.replace('manifest.json', 'versions.json');
try {
  const res = await fetch(versionsUrl);
  if (res.ok) {
    versionHistory = await res.json();
  }
} catch (e) {
  versionHistory = manifest.versions || [];
}

if (!versionHistory || versionHistory.length === 0) {
  versionHistory = [
    {
      version: manifest.version,
      date: manifest.publishedAt || manifest.updatedAt || '',
      changelog: manifest.changelog || 'Latest release'
    }
  ];
}

// Dependencies
if (Array.isArray(manifest.dependencies)) {
  dependencyList = manifest.dependencies;
} else if (manifest.dependencies && typeof manifest.dependencies === 'object') {
  dependencyList = Object.entries(manifest.dependencies).map(([dep, ver]) => ({ id: dep, version: ver }));
}
---

<Layout title={`${manifest.name} | nex`} description={manifest.description}>
  <div class="package-header">
    <div class="container">
      <div class="header-top">
        <h1>{manifest.name}</h1>
        <span class="version-tag">v{manifest.version}</span>
        {manifest.license && <span class="license-tag">{manifest.license}</span>}
      </div>
      <p class="package-description">{manifest.description}</p>
      
      <div class="package-tabs">
        <a href="#" class="tab active">Readme</a>
        <a href="#" class="tab">Code</a>
        <a href="#" class="tab">Dependencies</a>
        <a href="#" class="tab">Versions</a>
      </div>
    </div>
  </div>

  <main class="container">
    <div class="package-layout">
      <div class="main-column">
        <div class="readme-content">
          <section class="markdown-section">
            <h2>Usage</h2>
            <div class="code-block">
              <div class="code-header">
                <span>Run this package</span>
                <button class="copy-btn" data-copy={`nex run ${manifest.name.toLowerCase()}`}>
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="9" y="9" width="13" height="13" rx="2"/>
                    <path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/>
                  </svg>
                </button>
              </div>
              <pre><code>nex run {manifest.name.toLowerCase()}</code></pre>
            </div>
          </section>

          {manifest.commands && Object.keys(manifest.commands).length > 0 && (
            <section class="markdown-section">
              <h2>Available Commands</h2>
              <div class="commands-table">
                <table>
                  <thead>
                    <tr>
                      <th>Command</th>
                      <th>Runs</th>
                    </tr>
                  </thead>
                  <tbody>
                    {Object.entries(manifest.commands).map(([name, cmd]) => (
                      <tr>
                        <td><code>nex run {manifest.name.toLowerCase()} {name === 'default' ? '' : name}</code></td>
                        <td><code class="cmd-value">{cmd}</code></td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </section>
          )}

          {manifest.keywords && manifest.keywords.length > 0 && (
            <section class="markdown-section">
              <h2>Keywords</h2>
              <div class="keywords-list">
                {manifest.keywords.map((kw: string) => (
                  <a href="#" class="keyword-tag">{kw}</a>
                ))}
              </div>
            </section>
          )}

          {versionHistory && versionHistory.length > 0 && (
            <section class="markdown-section">
              <h2>Version History</h2>
              <div class="versions-list">
                {versionHistory.map((v) => (
                  <div class="version-item">
                    <div>
                      <div class="version-label">v{v.version}</div>
                      {v.date && <div class="version-date">{v.date}</div>}
                      {v.changelog && <p class="version-notes">{v.changelog}</p>}
                    </div>
                    <div class="version-actions">
                      <button class="copy-btn" data-copy={`nex install ${manifest.name.toLowerCase()}@${v.version}`} title="Copy install command">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <rect x="9" y="9" width="13" height="13" rx="2"/>
                          <path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/>
                        </svg>
                      </button>
                    </div>
                  </div>
                ))}
              </div>
            </section>
          )}

          {dependencyList && dependencyList.length > 0 && (
            <section class="markdown-section">
              <h2>Dependencies</h2>
              <div class="dependency-graph">
                {dependencyList.map((dep) => (
                  <div class="dependency-node">
                    <div class="dep-line"></div>
                    <div class="dep-card">
                      <div class="dep-name">{dep.id || dep.name}</div>
                      {dep.version && <div class="dep-version">{dep.version}</div>}
                      {dep.type && <span class="dep-tag">{dep.type}</span>}
                    </div>
                  </div>
                ))}
              </div>
            </section>
          )}
        </div>
      </div>

      <aside class="sidebar-column">
        <div class="sidebar-block">
          <h3>Install</h3>
          <div class="install-cmd-box">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="cmd-icon">
              <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
            </svg>
            <code>nex install {manifest.name.toLowerCase()}</code>
            <button class="copy-icon-btn" data-copy={`nex install ${manifest.name.toLowerCase()}`} title="Copy to clipboard">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="9" y="9" width="13" height="13" rx="2"/>
                <path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/>
              </svg>
            </button>
          </div>
        </div>

        <div class="sidebar-block">
          <h3>Repository</h3>
          {manifest.repository ? (
            <a href={manifest.repository} target="_blank" rel="noopener" class="sidebar-link">
              <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
                <path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0024 12c0-6.63-5.37-12-12-12z"/>
              </svg>
              <span>{manifest.repository.replace('https://github.com/', '')}</span>
            </a>
          ) : (
            <span class="sidebar-text">No repository linked</span>
          )}
        </div>

        <div class="sidebar-block">
          <h3>Details</h3>
          <div class="sidebar-info">
            {manifest.author && (
              <div class="info-item">
                <span class="label">Author</span>
                <span class="value">
                  {typeof manifest.author === 'string' ? manifest.author : (
                    manifest.author.github ? (
                      <a href={`https://github.com/${manifest.author.github}`} target="_blank" rel="noopener">
                        {manifest.author.name || manifest.author.github}
                      </a>
                    ) : manifest.author.name
                  )}
                </span>
              </div>
            )}
            
            <div class="info-item">
              <span class="label">Version</span>
              <span class="value">{manifest.version}</span>
            </div>

            {manifest.license && (
              <div class="info-item">
                <span class="label">License</span>
                <span class="value">{manifest.license}</span>
              </div>
            )}

            {manifest.runtime && (
              <div class="info-item">
                <span class="label">Runtime</span>
                <span class="value">{manifest.runtime.type} {manifest.runtime.version}</span>
              </div>
            )}
          </div>
        </div>

        {manifest.platforms && (
          <div class="sidebar-block">
            <h3>Platforms</h3>
            <div class="platforms-list">
              {manifest.platforms.map((p: string) => (
                <span class="platform-tag">{p}</span>
              ))}
            </div>
          </div>
        )}
      </aside>
    </div>
  </main>
</Layout>

<style>
  :root {
    --bg-main: #ffffff;      
    --bg-surface: #fafafa;   /* Zinc 50 */
    --bg-card: #ffffff;
    --border: #e4e4e7;       /* Zinc 200 */
    --text-primary: #18181b; /* Zinc 900 */
    --text-secondary: #71717a; /* Zinc 500 */
    --accent: #e11d48;       /* Rose 600 */
    --accent-glow: rgba(225, 29, 72, 0.1);
    --font-mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  }

  /* Global Reset & Base */
  body {
    background-color: var(--bg-main);
    color: var(--text-primary);
  }

  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 1.5rem;
  }

  /* --- Hero Header --- */
  .package-header {
    background: radial-gradient(circle at top center, #fff1f2 0%, #ffffff 70%);
    border-bottom: 1px solid var(--border);
    padding: 4rem 0 2rem;
    position: relative;
    overflow: hidden;
  }
  
  /* Subtle mesh effect overlay (lighter) */
  .package-header::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    background-image: 
      linear-gradient(rgba(0, 0, 0, 0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0, 0, 0, 0.03) 1px, transparent 1px);
    background-size: 40px 40px;
    mask-image: linear-gradient(to bottom, black 40%, transparent 100%);
    pointer-events: none;
  }

  .header-top {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
    position: relative;
    z-index: 1;
  }

  .header-top h1 {
    font-size: 2.5rem;
    font-weight: 800;
    letter-spacing: -0.02em;
    color: var(--text-primary);
    background: none;
    -webkit-text-fill-color: initial;
    margin: 0;
  }

  .version-tag {
    background: #fff;
    border: 1px solid var(--border);
    color: var(--accent);
    font-family: var(--font-mono);
    font-size: 0.85rem;
    padding: 0.2rem 0.6rem;
    border-radius: 6px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
  }

  .license-tag {
    font-size: 0.8rem;
    color: var(--text-secondary);
    border: 1px solid var(--border);
    padding: 0.2rem 0.6rem;
    border-radius: 99px;
    background: #fff;
  }

  .package-description {
    font-size: 1.125rem;
    line-height: 1.6;
    color: var(--text-secondary);
    max-width: 700px;
    margin-bottom: 2.5rem;
    position: relative;
    z-index: 1;
  }

  /* --- Tabs --- */
  .package-tabs {
    display: flex;
    gap: 0.5rem;
    position: relative;
    z-index: 1;
  }

  .tab {
    text-decoration: none;
    color: var(--text-secondary);
    padding: 0.75rem 1.25rem;
    font-size: 0.95rem;
    font-weight: 500;
    border-radius: 8px 8px 0 0;
    border-bottom: 2px solid transparent;
    transition: all 0.2s ease;
  }

  .tab:hover {
    color: var(--text-primary);
    background: var(--bg-surface);
  }

  .tab.active {
    color: var(--accent);
    border-bottom-color: var(--accent);
    background: linear-gradient(to top, rgba(225, 29, 72, 0.05), transparent);
  }

  /* --- Main Layout --- */
  .package-layout {
    display: grid;
    grid-template-columns: minmax(0, 1fr) 320px;
    gap: 3rem;
    padding: 3rem 0;
  }


  /* --- Content Sections --- */
  .markdown-section {
    margin-bottom: 3rem;
  }

  .markdown-section h2 {
    font-size: 1.5rem;
    color: var(--text-primary);
    margin-bottom: 1.5rem;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid var(--border);
  }

  /* Code Blocks (Command Runner) */
  .code-block {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 20px rgba(0,0,0,0.2);
  }

  .code-header {
    background: var(--bg-surface);
    border-bottom: 1px solid var(--border);
    padding: 0.75rem 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .code-header span {
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-secondary);
    font-weight: 600;
  }

  .code-block pre {
    margin: 0;
    padding: 1.25rem;
    overflow-x: auto;
    background: transparent;
  }

  .code-block code {
    font-family: var(--font-mono);
    color: #a5b4fc; /* Light Indigo */
    font-size: 0.95rem;
  }

  /* --- Sidebar --- */
  .sidebar-column {
    position: sticky;
    top: 2rem;
    height: fit-content;
  }

  .sidebar-block {
    background: var(--bg-surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 1.25rem;
    margin-bottom: 1.5rem;
  }

  .sidebar-block h3 {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-secondary);
    margin-bottom: 1rem;
  }

  /* Install Box */
  .install-cmd-box {
    background: #000;
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 0.75rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-family: var(--font-mono);
    font-size: 0.85rem;
    color: var(--accent);
    transition: border-color 0.2s;
  }

  .install-cmd-box:hover {
    border-color: var(--accent);
    box-shadow: 0 0 0 1px var(--accent-glow);
  }

  .cmd-icon {
    width: 16px; height: 16px;
    opacity: 0.7;
  }

  .install-cmd-box code {
    flex: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  /* Copy Button */
  .copy-icon-btn, .copy-btn {
    background: transparent;
    border: 1px solid var(--border);
    color: var(--text-secondary);
    border-radius: 6px;
    padding: 4px;
    cursor: pointer;
    transition: all 0.2s;
    display: flex; align-items: center; justify-content: center;
  }

  .copy-icon-btn:hover, .copy-btn:hover {
    background: var(--bg-surface);
    color: var(--text-primary);
    border-color: var(--text-secondary);
  }

  /* Links */
  .sidebar-link {
    color: var(--text-primary);
    text-decoration: none;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0;
    transition: color 0.2s;
  }

  .sidebar-link:hover {
    color: var(--accent);
  }

  /* Dependency Graph */
  .dependency-graph {
    display: grid;
    gap: 1rem;
  }

  .dependency-node {
    display: grid;
    grid-template-columns: 20px 1fr;
    gap: 1rem;
    align-items: center;
  }

  .dep-line {
    width: 2px;
    height: 100%;
    background: var(--border);
    position: relative;
    left: 9px;
  }
  
  .dep-node::before {
    /* Dot */
    content: '';
    width: 10px; height: 10px;
    background: var(--border);
    border-radius: 50%;
  }

  .dep-card {
    background: var(--bg-surface);
    border: 1px solid var(--border);
    padding: 1rem;
    border-radius: 8px;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .package-layout { grid-template-columns: 1fr; }
    .sidebar-column { position: static; order: -1; }
    .header-top h1 { font-size: 1.75rem; }
  }
</style>

<script>
  const copyToClipboard = async (btn: HTMLElement) => {
    const text = btn.dataset.copy;
    if (text) {
      try {
        await navigator.clipboard.writeText(text);
        const svg = btn.querySelector('svg');
        const original = svg ? svg.innerHTML : null;
        const originalText = btn.textContent;

        if (svg) {
          svg.innerHTML = '<path d="M20 6L9 17l-5-5" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>';
        } else {
          btn.textContent = 'Copied!';
        }

        btn.classList.add('copied');
        setTimeout(() => {
          if (svg && original !== null) svg.innerHTML = original;
          if (!svg && originalText) btn.textContent = originalText;
          btn.classList.remove('copied');
        }, 1500);
      } catch (err) {
        console.error('Failed to copy:', err);
      }
    }
  };

  document.querySelectorAll('.copy-btn, .copy-icon-btn').forEach(btn => {
    btn.addEventListener('click', () => copyToClipboard(btn as HTMLElement));
  });

  // Simple canvas bar chart for downloads
  const chartEl = document.getElementById('download-chart') as HTMLCanvasElement;
  if (chartEl) {
    const ctx = chartEl.getContext('2d');
    const series = JSON.parse(chartEl.dataset.series || '[]');
    if (ctx && series.length) {
      const padding = 32;
      const width = chartEl.width - padding * 2;
      const height = chartEl.height - padding * 2;
      const max = Math.max(...series.map((s: any) => s.count));
      const barWidth = width / series.length - 12;

      ctx.clearRect(0, 0, chartEl.width, chartEl.height);
      ctx.fillStyle = '#0f0f0f';
      ctx.fillRect(0, 0, chartEl.width, chartEl.height);

      series.forEach((s: any, idx: number) => {
        const x = padding + idx * (barWidth + 12);
        const barHeight = max ? (s.count / max) * height : 0;
        const y = chartEl.height - padding - barHeight;
        ctx.fillStyle = '#cb3837';
        ctx.fillRect(x, y, barWidth, barHeight);
        ctx.fillStyle = '#ccc';
        ctx.font = '10px monospace';
        ctx.fillText(s.date || '', x, chartEl.height - padding + 12);
      });
    }
  }
</script>
