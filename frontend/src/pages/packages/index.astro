---
import Layout from '../../layouts/Layout.astro';

// Fetch packages from registry (at build time)
const registryUrl = 'https://raw.githubusercontent.com/devkiraa/nex/main/registry/index.json';
let packages = [];

try {
  if (import.meta.env.DEV) {
    packages = [
      {
        id: 'example.hello-world',
        name: 'Hello World',
        version: '1.0.0',
        description: 'A simple example package demonstrating nex structure',
        keywords: ['example', 'demo', 'hello']
      }
    ];
  } else {
    const response = await fetch(registryUrl);
    const data = await response.json();
    packages = data.packages || [];
  }
} catch (e) {
  packages = [];
}
---

<Layout title="Packages" description="Browse all available Nex packages">
  <div class="container">
    <header class="page-header">
      <h1>ðŸ“¦ Packages</h1>
      <p>Browse and discover developer tools</p>
    </header>
    
    <div class="search-bar">
      <input 
        type="search" 
        id="package-search" 
        placeholder="Search packages..." 
        autocomplete="off"
      />
    </div>
    
    <div class="package-count">
      <span id="count">{packages.length}</span> package(s) available
    </div>
    
    <div class="package-list" id="package-list">
      {packages.map((pkg) => (
        <a 
          href={`${import.meta.env.BASE_URL}packages/${pkg.id}`} 
          class="package-item"
          data-name={pkg.name.toLowerCase()}
          data-id={pkg.id.toLowerCase()}
          data-description={pkg.description?.toLowerCase() || ''}
          data-keywords={pkg.keywords?.join(' ').toLowerCase() || ''}
        >
          <div class="package-info">
            <h3>{pkg.name}</h3>
            <code class="package-id">{pkg.id}</code>
            <p class="description">{pkg.description}</p>
          </div>
          <div class="package-meta">
            <span class="version">v{pkg.version}</span>
            <div class="keywords">
              {pkg.keywords?.slice(0, 5).map((kw) => (
                <span class="keyword">{kw}</span>
              ))}
            </div>
          </div>
          <div class="install-hint">
            <code>nex install {pkg.id}</code>
          </div>
        </a>
      ))}
    </div>
    
    {packages.length === 0 && (
      <div class="empty-state">
        <p>No packages found.</p>
        <p>Be the first to <a href="https://github.com/devkiraa/nex">submit a package</a>!</p>
      </div>
    )}
  </div>
</Layout>

<style>
  .container {
    max-width: 900px;
    margin: 0 auto;
    padding: 2rem 1rem;
  }
  
  .page-header {
    text-align: center;
    margin-bottom: 2rem;
  }
  
  .page-header h1 {
    font-size: 2.5rem;
    margin-bottom: 0.5rem;
  }
  
  .page-header p {
    color: var(--color-text-muted);
    font-size: 1.1rem;
  }
  
  .search-bar {
    margin-bottom: 1rem;
  }
  
  .search-bar input {
    width: 100%;
    padding: 0.75rem 1rem;
    font-size: 1rem;
    background-color: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: 8px;
    color: var(--color-text);
  }
  
  .search-bar input:focus {
    outline: none;
    border-color: var(--color-primary);
  }
  
  .search-bar input::placeholder {
    color: var(--color-text-muted);
  }
  
  .package-count {
    color: var(--color-text-muted);
    margin-bottom: 1.5rem;
  }
  
  .package-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }
  
  .package-item {
    display: block;
    background-color: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: 8px;
    padding: 1.5rem;
    color: var(--color-text);
    transition: all 0.2s;
  }
  
  .package-item:hover {
    border-color: var(--color-primary);
    text-decoration: none;
  }
  
  .package-item.hidden {
    display: none;
  }
  
  .package-info h3 {
    font-size: 1.25rem;
    margin-bottom: 0.25rem;
  }
  
  .package-id {
    font-size: 0.875rem;
    color: var(--color-text-muted);
  }
  
  .description {
    color: var(--color-text-muted);
    margin: 0.5rem 0;
  }
  
  .package-meta {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 0.5rem;
    margin: 1rem 0;
  }
  
  .version {
    background-color: rgba(63, 185, 80, 0.2);
    color: var(--color-success);
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 600;
  }
  
  .keywords {
    display: flex;
    flex-wrap: wrap;
    gap: 0.25rem;
  }
  
  .keyword {
    background-color: var(--color-bg);
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    color: var(--color-text-muted);
  }
  
  .install-hint {
    padding-top: 0.5rem;
    border-top: 1px solid var(--color-border);
  }
  
  .install-hint code {
    font-size: 0.875rem;
    color: var(--color-primary);
    background: none;
    padding: 0;
  }
  
  .empty-state {
    text-align: center;
    padding: 4rem 0;
    color: var(--color-text-muted);
  }
</style>

<script>
  const searchInput = document.getElementById('package-search');
  const packageList = document.getElementById('package-list');
  const countEl = document.getElementById('count');
  const packages = packageList?.querySelectorAll('.package-item');
  
  searchInput?.addEventListener('input', (e) => {
    const query = e.target.value.toLowerCase().trim();
    let visible = 0;
    
    packages?.forEach(pkg => {
      const name = pkg.dataset.name || '';
      const id = pkg.dataset.id || '';
      const desc = pkg.dataset.description || '';
      const keywords = pkg.dataset.keywords || '';
      
      const matches = query === '' || 
        name.includes(query) || 
        id.includes(query) || 
        desc.includes(query) ||
        keywords.includes(query);
      
      if (matches) {
        pkg.classList.remove('hidden');
        visible++;
      } else {
        pkg.classList.add('hidden');
      }
    });
    
    if (countEl) countEl.textContent = visible.toString();
  });
</script>
