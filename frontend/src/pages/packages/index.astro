---
import Layout from '../../layouts/Layout.astro';

// Fetch packages from backend API
const registryUrl = 'https://nex-9ujp.onrender.com/api/packages';
let packages: any[] = [];
let error = null;

try {
  const response = await fetch(registryUrl, { cache: 'no-store' });
  if (response.ok) {
    const data = await response.json();
    packages = data.packages || [];
  } else {
    error = `API Error: ${response.status}`;
    console.error(error);
  }
} catch (e) {
  error = 'Could not connect to registry backend';
  console.error("Failed to load registry:", e);
  packages = [];
}

// Normalize and enrich package metadata for filtering
const deriveCategory = (pkg: any) => {
  const keywords = (Array.isArray(pkg?.keywords) ? pkg.keywords : []).map((k: any) => String(k).toLowerCase());
  if (keywords.some((k: string) => k.includes('cli'))) return 'CLI';
  if (keywords.some((k: string) => k.includes('dev') || k.includes('build'))) return 'Dev Tools';
  if (keywords.some((k: string) => k.includes('util') || k.includes('helper'))) return 'Utilities';
  if (keywords.some((k: string) => k.includes('ai') || k.includes('ml'))) return 'AI/ML';
  if (keywords.some((k: string) => k.includes('data'))) return 'Data';
  return 'General';
};

const extractAuthor = (pkg: any) => {
  if (!pkg.author) return 'Unknown';
  if (typeof pkg.author === 'string') return pkg.author;
  return pkg.author.name || pkg.author.github || 'Unknown';
};

packages = packages.map((pkg: any) => {
  const authorName = extractAuthor(pkg);
  const category = deriveCategory(pkg);
  const publishedAt = pkg.publishedAt || pkg.updatedAt || pkg.releaseDate || '';
  const downloads = pkg.downloads || pkg.stats?.downloads || 0;
  return {
    ...pkg,
    authorName,
    category,
    publishedAt,
    downloads,
  };
});

const allKeywords = [...new Set(
  packages
    .flatMap((p: any) => (Array.isArray(p?.keywords) ? p.keywords : []))
    .map((kw: any) => String(kw))
)];
const authors = [...new Set(packages.map((p: any) => String(p?.authorName || 'Unknown')))].sort();
const categories = Object.entries(
  packages.reduce((acc: Record<string, number>, pkg: any) => {
    acc[pkg.category] = (acc[pkg.category] || 0) + 1;
    return acc;
  }, {} as Record<string, number>)
).map(([name, count]) => ({ name, count })).sort((a, b) => a.name.localeCompare(b.name));

const baseUrl = import.meta.env.BASE_URL;
---

<Layout title="Search Packages | nex" description="Search and browse nex packages">
  <header class="page-header">
    <div class="container">
      <div class="page-title">
        <h1>Packages</h1>
        <p>Search the registry and install tools in seconds.</p>
      </div>

      <div class="search-row">
        <div class="search-box">
          <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
          </svg>
          <input
            type="search"
            id="package-search"
            placeholder="Search packages (name, id, description, keywords)"
            autocomplete="off"
          />
          <kbd class="search-shortcut" aria-hidden="true">/</kbd>
        </div>

        <button class="btn btn-secondary" id="clear-search" type="button">Clear</button>
      </div>
    </div>
  </header>

  <main class="container page-body">
    <aside class="sidebar" aria-label="Filters">
      <div class="panel">
        <div class="panel-head">
          <h2>Filters</h2>
          <button id="reset-filters" class="btn btn-secondary" type="button">Reset</button>
        </div>

        <div class="field">
          <label for="author-filter">Author</label>
          <select id="author-filter">
            <option value="all">All authors</option>
            {authors.map((author: string) => (
              <option value={author.toLowerCase()}>{author}</option>
            ))}
          </select>
        </div>

        <div class="field">
          <label for="download-filter">Min downloads</label>
          <input type="number" id="download-filter" min="0" placeholder="0" />
        </div>

        <div class="field">
          <label for="date-filter">Published after</label>
          <input type="date" id="date-filter" />
        </div>

        <div class="field">
          <label>Tags</label>
          <div class="tag-grid" id="tag-filter">
            {allKeywords.slice(0, 14).map((kw: string) => (
              <label class="tag-chip">
                <input type="checkbox" value={kw.toLowerCase()} class="tag-checkbox" />
                <span>{kw}</span>
              </label>
            ))}
          </div>
        </div>
      </div>
    </aside>

    <section class="results" aria-label="Search results">
      <div class="panel">
        <div class="results-top">
          <div class="count">
            <span class="count-number" id="count">{packages.length}</span>
            <span class="count-label">packages</span>
          </div>

          <div class="tools">
            <label class="tool">
              <span>Sort</span>
              <select id="sort-select">
                <option value="relevance">Relevance</option>
                <option value="name">Name (A–Z)</option>
                <option value="name-desc">Name (Z–A)</option>
                <option value="downloads">Downloads</option>
                <option value="published">Newest</option>
              </select>
            </label>

            <div class="view-toggle" role="group" aria-label="View">
              <button class="view-btn active" data-view="grid" type="button" title="Grid">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                  <rect x="3" y="3" width="7" height="7"/>
                  <rect x="14" y="3" width="7" height="7"/>
                  <rect x="3" y="14" width="7" height="7"/>
                  <rect x="14" y="14" width="7" height="7"/>
                </svg>
              </button>
              <button class="view-btn" data-view="list" type="button" title="List">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                  <line x1="8" y1="6" x2="21" y2="6"/>
                  <line x1="8" y1="12" x2="21" y2="12"/>
                  <line x1="8" y1="18" x2="21" y2="18"/>
                  <line x1="3" y1="6" x2="3.01" y2="6"/>
                  <line x1="3" y1="12" x2="3.01" y2="12"/>
                  <line x1="3" y1="18" x2="3.01" y2="18"/>
                </svg>
              </button>
            </div>
          </div>
        </div>

        <div class="categories" aria-label="Categories">
          <button class="chip active" data-category="all" type="button">All <span class="chip-count">{packages.length}</span></button>
          {categories.map((cat) => (
            <button class="chip" data-category={cat.name.toLowerCase()} type="button">{cat.name} <span class="chip-count">{cat.count}</span></button>
          ))}
        </div>

        <div class="package-grid" id="package-list">
      {packages.map((pkg: any, index: number) => (
        <article 
          class="package-card"
          data-name={pkg.name.toLowerCase()}
          data-id={pkg.id.toLowerCase()}
          data-description={pkg.description?.toLowerCase() || ''}
          data-keywords={pkg.keywords?.join(' ').toLowerCase() || ''}
          data-tags={pkg.keywords?.join(' ').toLowerCase() || ''}
          data-category={(pkg.category || 'general').toLowerCase()}
          data-author={(pkg.authorName || 'unknown').toLowerCase()}
          data-date={pkg.publishedAt || ''}
          data-downloads={pkg.downloads || 0}
        >
          <div class="card-main">
            <a href={`${baseUrl}packages/view?id=${pkg.id}`} class="card-link" aria-label={`View ${pkg.name}`}>
              <div class="card-header">
                <div class="icon-box">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                    <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                    <line x1="12" y1="22.08" x2="12" y2="12"></line>
                  </svg>
                </div>
                <div class="card-title-group">
                  <div class="title-row">
                    <h3>{pkg.name}</h3>
                    <span class="version-badge">v{pkg.version}</span>
                  </div>
                  <div class="sub-row">
                     <span class="author">by {pkg.authorName || 'Unknown'}</span>
                     <span class="dot">•</span>
                     <span class="downloads">{pkg.downloads} downloads</span>
                  </div>
                </div>
              </div>
              
              <p class="description">{pkg.description}</p>
              
              <div class="tags">
                {pkg.keywords?.slice(0, 3).map((kw: string) => (
                  <span class="tag">{kw}</span>
                ))}
              </div>
            </a>
          </div>

          <div class="card-footer">
            <div class="install-box" title="Click to copy" onclick="this.nextElementSibling.click()">
              <span class="cmd-prompt">$</span>
              <span class="cmd-text">nex install {pkg.name.toLowerCase()}</span>
            </div>
            <button class="copy-btn-icon" data-copy={`nex install ${pkg.name.toLowerCase()}`} type="button" aria-label="Copy command">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
              </svg>
            </button>
          </div>
        </article>
      ))}
        </div>

        <div class="no-results" id="no-results" style="display:none;">
          <h3>No packages found</h3>
          <p>Try a different search or clear filters.</p>
        </div>

        {packages.length === 0 && (
          <div class="empty-state">
            <h3>No packages available yet</h3>
            <p>Be the first to contribute to the registry.</p>
            <a href="https://github.com/nexhq/nex" class="btn btn-primary">Submit a Package</a>
          </div>
        )}
      </div>
    </section>
  </main>
</Layout>

<style>
  .page-header {
    background: var(--nex-white);
    border-bottom: 1px solid var(--nex-border);
    padding: 2rem 0 1.25rem;
  }

  .page-title h1 {
    font-size: 2rem;
    line-height: 1.1;
    margin-bottom: 0.35rem;
  }

  .page-title p {
    color: var(--nex-gray);
    max-width: 60ch;
  }

  .search-row {
    margin-top: 1rem;
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 0.75rem;
    align-items: center;
  }

  .search-box {
    position: relative;
  }

  .search-icon {
    position: absolute;
    left: 0.9rem;
    top: 50%;
    transform: translateY(-50%);
    width: 20px;
    height: 20px;
    color: var(--nex-gray);
  }

  .search-box input {
    width: 100%;
    padding: 0.9rem 2.75rem 0.9rem 2.75rem;
    font-size: 1rem;
    border: 1px solid var(--nex-border);
    border-radius: var(--radius);
    background: var(--nex-white);
  }

  .search-box input:focus {
    outline: none;
    border-color: var(--nex-red);
    box-shadow: 0 0 0 3px color-mix(in srgb, var(--nex-red) 18%, transparent);
  }

  .search-shortcut {
    position: absolute;
    right: 0.75rem;
    top: 50%;
    transform: translateY(-50%);
    border: 1px solid var(--nex-border);
    background: var(--nex-bg);
    border-radius: 6px;
    padding: 0.1rem 0.45rem;
    font-size: 0.85rem;
    color: var(--nex-gray);
  }

  .page-body {
    padding: 1.25rem 0 3rem;
    display: grid;
    grid-template-columns: 320px 1fr;
    gap: 1.25rem;
    align-items: start;
  }

  .panel {
    background: var(--nex-white);
    border: 1px solid var(--nex-border);
    border-radius: var(--radius);
    box-shadow: var(--shadow-sm);
    padding: 1rem;
  }

  .sidebar {
    position: sticky;
    top: 1rem;
  }

  .panel-head {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.75rem;
    margin-bottom: 1rem;
  }

  .panel-head h2 {
    font-size: 1rem;
  }

  .field {
    display: grid;
    gap: 0.5rem;
    margin-bottom: 1rem;
  }

  .field label {
    font-weight: 600;
    font-size: 0.9rem;
    color: var(--nex-dark);
  }

  .field select,
  .field input[type="date"],
  .field input[type="number"] {
    width: 100%;
    padding: 0.65rem 0.75rem;
    border: 1px solid var(--nex-border);
    border-radius: var(--radius);
    background: var(--nex-white);
    font-family: inherit;
    font-size: 0.95rem;
  }

  .tag-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .tag-chip {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.35rem 0.6rem;
    border: 1px solid var(--nex-border);
    border-radius: 999px;
    background: var(--nex-bg);
    font-size: 0.85rem;
    color: var(--nex-dark);
    cursor: pointer;
    user-select: none;
  }

  .tag-chip input {
    accent-color: var(--nex-red);
  }

  .results-top {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    flex-wrap: wrap;
    margin-bottom: 0.75rem;
  }

  .count {
    display: inline-flex;
    align-items: baseline;
    gap: 0.4rem;
  }

  .count-number {
    font-weight: 700;
    font-size: 1.25rem;
    color: var(--nex-black);
  }

  .count-label {
    color: var(--nex-gray);
  }

  .tools {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .tool {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--nex-gray);
    font-size: 0.9rem;
  }

  .tool select {
    padding: 0.5rem 0.6rem;
    border: 1px solid var(--nex-border);
    border-radius: 8px;
    background: var(--nex-white);
    font-family: inherit;
    color: var(--nex-black);
  }

  .view-toggle {
    display: inline-flex;
    border: 1px solid var(--nex-border);
    border-radius: 8px;
    overflow: hidden;
  }

  .view-btn {
    border: none;
    background: var(--nex-white);
    color: var(--nex-gray);
    padding: 0.5rem 0.65rem;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
  }

  .view-btn + .view-btn {
    border-left: 1px solid var(--nex-border);
  }

  .view-btn.active {
    background: var(--nex-red);
    color: var(--nex-white);
  }

  .categories {
    display: flex;
    flex-wrap: nowrap;
    overflow-x: auto;
    gap: 0.5rem;
    padding: 0.25rem 0;
    margin-bottom: 1rem;
    -webkit-overflow-scrolling: touch;
  }

  .chip {
    flex: 0 0 auto;
    border: 1px solid var(--nex-border);
    background: var(--nex-white);
    color: var(--nex-dark);
    border-radius: 999px;
    padding: 0.4rem 0.75rem;
    cursor: pointer;
    font-weight: 600;
    font-size: 0.9rem;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
  }

  .chip-count {
    font-weight: 700;
    color: var(--nex-gray);
    background: var(--nex-bg);
    border: 1px solid var(--nex-border);
    border-radius: 999px;
    padding: 0.05rem 0.5rem;
    font-size: 0.85rem;
  }

  .chip.active {
    border-color: var(--nex-red);
    color: var(--nex-red);
  }

  .package-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 1rem;
  }

  .package-grid.list-view {
    grid-template-columns: 1fr;
  }

  .package-card {
    border: 1px solid var(--nex-border);
    border-radius: 12px;
    background: var(--nex-white);
    display: flex;
    flex-direction: column;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
  }

  .package-card:hover {
    border-color: #f43f5e; /* Rose 500 */
    box-shadow: 0 10px 30px -10px rgba(244, 63, 94, 0.15);
    transform: translateY(-2px);
  }

  .card-main {
    flex: 1;
    display: flex;
    flex-direction: column;
  }

  .card-link {
    padding: 1.25rem;
    color: inherit;
    text-decoration: none;
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .card-header {
    display: grid;
    grid-template-columns: 48px 1fr;
    gap: 1rem;
    align-items: start;
  }

  .icon-box {
    width: 48px;
    height: 48px;
    background: #fff1f2; /* Rose 50 */
    color: #e11d48;      /* Rose 600 */
    border-radius: 10px;
    display: grid;
    place-items: center;
    border: 1px solid rgba(225, 29, 72, 0.1);
  }

  .card-title-group {
    min-width: 0;
  }

  .title-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.5rem;
    margin-bottom: 0.25rem;
  }

  .title-row h3 {
    margin: 0;
    font-size: 1.125rem;
    font-weight: 700;
    color: var(--nex-black);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .version-badge {
    font-size: 0.75rem;
    padding: 0.1rem 0.5rem;
    background: var(--nex-bg);
    border: 1px solid var(--nex-border);
    border-radius: 99px;
    color: var(--nex-gray);
    font-family: var(--font-mono);
  }

  .sub-row {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.85rem;
    color: var(--nex-gray);
    flex-wrap: wrap;
  }

  .dot {
    opacity: 0.4;
  }

  .description {
    font-size: 0.95rem;
    color: #52525b; /* Zinc 600 */
    line-height: 1.5;
    margin: 0;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    flex: 1;
  }

  .tags {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    margin-top: auto;
  }

  .tag {
    font-size: 0.75rem;
    padding: 2px 8px;
    background: var(--nex-bg);
    border: 1px solid var(--nex-border);
    border-radius: 6px;
    color: #52525b;
  }

  .card-footer {
    padding: 0.75rem 1.25rem;
    background: #fafafa;
    border-top: 1px solid var(--nex-border);
    display: flex;
    gap: 0.75rem;
    align-items: center;
  }

  .install-box {
    flex: 1;
    background: #fff;
    border: 1px solid var(--nex-border);
    border-radius: 6px;
    padding: 0.5rem 0.75rem;
    font-family: var(--font-mono);
    font-size: 0.85rem;
    display: flex;
    gap: 0.5rem;
    align-items: center;
    cursor: pointer;
    transition: all 0.2s;
    overflow: hidden;
  }

  .install-box:hover {
    border-color: #fda4af; /* Rose 300 */
    box-shadow: 0 0 0 2px rgba(244, 63, 94, 0.1);
  }

  .install-box:active {
    background: #fff1f2;
  }

  .cmd-prompt {
    color: #a1a1aa;
    user-select: none;
  }

  .cmd-text {
    color: #3f3f46; /* Zinc 700 */
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .copy-btn-icon {
    width: 32px;
    height: 32px;
    display: grid;
    place-items: center;
    border: 1px solid var(--nex-border);
    background: #fff;
    border-radius: 6px;
    color: var(--nex-gray);
    cursor: pointer;
    transition: all 0.2s;
  }

  .copy-btn-icon:hover {
    border-color: #f43f5e;
    color: #f43f5e;
  }

  .no-results {
    padding: 1rem;
    border-top: 1px solid var(--nex-border);
    margin-top: 0.5rem;
    color: var(--nex-gray);
  }

  .no-results h3 {
    color: var(--nex-black);
    margin-bottom: 0.25rem;
  }

  .empty-state {
    padding: 1rem;
    border-top: 1px solid var(--nex-border);
    color: var(--nex-gray);
  }

  @media (max-width: 980px) {
    .page-body {
      grid-template-columns: 1fr;
    }

    .sidebar {
      position: static;
    }
  }

  @media (max-width: 520px) {
    .search-row {
      grid-template-columns: 1fr;
    }

    .search-shortcut {
      display: none;
    }

    .tools {
      width: 100%;
      justify-content: space-between;
    }

    .tool span {
      display: none;
    }

    .card-top {
      grid-template-columns: 44px 1fr;
      grid-template-rows: auto auto;
    }

    .version {
      grid-column: 2 / 3;
      justify-self: start;
      margin-top: 0.25rem;
    }

    .cmd {
      font-size: 0.85rem;
      word-break: break-all;
    }
  }
</style>

<script>
  const searchInput = document.getElementById('package-search') as HTMLInputElement | null;
  const packageList = document.getElementById('package-list');
  const countEl = document.getElementById('count');
  const noResults = document.getElementById('no-results');
  const sortSelect = document.getElementById('sort-select') as HTMLSelectElement | null;
  const viewButtons = document.querySelectorAll('.view-btn');
  const clearSearchBtn = document.getElementById('clear-search');
  const authorSelect = document.getElementById('author-filter') as HTMLSelectElement | null;
  const tagCheckboxes = document.querySelectorAll('.tag-checkbox');
  const dateInput = document.getElementById('date-filter') as HTMLInputElement | null;
  const downloadInput = document.getElementById('download-filter') as HTMLInputElement | null;
  const resetFiltersBtn = document.getElementById('reset-filters');
  const categoryChips = document.querySelectorAll('.chip');

  let currentCategory = 'all';

  const parseDate = (value: string | undefined) => {
    if (!value) return null;
    const d = new Date(value);
    return Number.isNaN(d.getTime()) ? null : d;
  };

  const semverCompare = (a: string, b: string) => {
    const clean = (v: string) => v.replace(/^v/i, '').trim();
    const pa = clean(a).split('.').map((x) => parseInt(x, 10));
    const pb = clean(b).split('.').map((x) => parseInt(x, 10));
    for (let i = 0; i < Math.max(pa.length, pb.length); i++) {
      const da = pa[i] ?? 0;
      const db = pb[i] ?? 0;
      if (da !== db) return da - db;
    }
    return 0;
  };

  function filterPackages() {
    if (!packageList || !countEl) return;

    const query = (searchInput?.value || '').toLowerCase().trim();
    const authorValue = authorSelect?.value || 'all';
    const minDownloads = parseInt(downloadInput?.value || '0', 10) || 0;
    const dateFilter = dateInput?.value ? parseDate(dateInput.value) : null;
    const selectedTags = Array.from(tagCheckboxes)
      .filter((cb: any) => cb.checked)
      .map((cb: any) => cb.value);

    const items = packageList.querySelectorAll('.package-card');
    let visible = 0;

    items.forEach((item) => {
      const el = item as HTMLElement;
      const name = el.dataset.name || '';
      const id = el.dataset.id || '';
      const desc = el.dataset.description || '';
      const keywords = el.dataset.keywords || '';
      const tags = el.dataset.tags || '';
      const author = el.dataset.author || 'unknown';
      const publishedAt = parseDate(el.dataset.date);
      const downloads = parseInt(el.dataset.downloads || '0', 10) || 0;
      const category = el.dataset.category || 'general';

      const matchesQuery =
        !query || name.includes(query) || id.includes(query) || desc.includes(query) || keywords.includes(query);
      const matchesCategory = currentCategory === 'all' || category === currentCategory;
      const matchesAuthor = authorValue === 'all' || author === authorValue;
      const matchesDownloads = downloads >= minDownloads;
      const matchesDate = !dateFilter || (publishedAt && publishedAt >= dateFilter);
      const matchesTags = selectedTags.length === 0 || selectedTags.every((t) => tags.includes(t));

      const show = matchesQuery && matchesCategory && matchesAuthor && matchesDownloads && matchesDate && matchesTags;
      el.style.display = show ? '' : 'none';
      if (show) visible++;
    });

    countEl.textContent = visible.toString();

    if (noResults) {
      noResults.style.display = visible === 0 ? 'block' : 'none';
    }
  }

  // Search input
  if (searchInput) {
    searchInput.addEventListener('input', filterPackages);

    document.addEventListener('keydown', (e) => {
      if (e.key === '/' && document.activeElement !== searchInput) {
        e.preventDefault();
        searchInput.focus();
      } else if (e.key === 'k' && (e.ctrlKey || e.metaKey)) {
        e.preventDefault();
        searchInput.focus();
        searchInput.select();
      }
    });
  }

  // Category chips
  categoryChips.forEach((chip) => {
    chip.addEventListener('click', () => {
      categoryChips.forEach((c) => c.classList.remove('active'));
      chip.classList.add('active');
      currentCategory = (chip as HTMLElement).dataset.category || 'all';
      filterPackages();
    });
  });

  // Filters
  authorSelect?.addEventListener('change', filterPackages);
  tagCheckboxes.forEach((cb) => cb.addEventListener('change', filterPackages));
  dateInput?.addEventListener('change', filterPackages);
  downloadInput?.addEventListener('input', filterPackages);

  // Reset
  resetFiltersBtn?.addEventListener('click', () => {
    if (authorSelect) authorSelect.value = 'all';
    if (dateInput) dateInput.value = '';
    if (downloadInput) downloadInput.value = '';
    tagCheckboxes.forEach((cb: any) => (cb.checked = false));
    categoryChips.forEach((c) => c.classList.remove('active'));
    categoryChips[0]?.classList.add('active');
    currentCategory = 'all';
    filterPackages();
  });

  // Sort
  sortSelect?.addEventListener('change', () => {
    if (!packageList) return;
    const items = [...packageList.querySelectorAll('.package-card')] as HTMLElement[];

    const scoreForRelevance = (el: HTMLElement, q: string) => {
      if (!q) return 0;
      const name = el.dataset.name || '';
      const id = el.dataset.id || '';
      const desc = el.dataset.description || '';
      const keywords = el.dataset.keywords || '';

      let score = 0;
      if (id.startsWith(q)) score += 6;
      if (name.startsWith(q)) score += 5;
      if (id.includes(q)) score += 4;
      if (name.includes(q)) score += 3;
      if (keywords.includes(q)) score += 2;
      if (desc.includes(q)) score += 1;
      return score;
    };

    const q = (searchInput?.value || '').toLowerCase().trim();

    items.sort((a, b) => {
      const nameA = a.dataset.name || '';
      const nameB = b.dataset.name || '';
      const downloadsA = parseInt(a.dataset.downloads || '0', 10) || 0;
      const downloadsB = parseInt(b.dataset.downloads || '0', 10) || 0;
      const dateA = parseDate(a.dataset.date)?.getTime() || 0;
      const dateB = parseDate(b.dataset.date)?.getTime() || 0;

      switch (sortSelect.value) {
        case 'name':
          return nameA.localeCompare(nameB);
        case 'name-desc':
          return nameB.localeCompare(nameA);
        case 'downloads':
          return downloadsB - downloadsA;
        case 'published':
          return dateB - dateA;
        case 'relevance':
        default: {
          const sa = scoreForRelevance(a, q);
          const sb = scoreForRelevance(b, q);
          if (sb !== sa) return sb - sa;
          return nameA.localeCompare(nameB);
        }
      }
    });

    items.forEach((item) => packageList.appendChild(item));
  });

  // View toggle
  viewButtons.forEach((btn) => {
    btn.addEventListener('click', () => {
      viewButtons.forEach((b) => b.classList.remove('active'));
      btn.classList.add('active');

      const view = (btn as HTMLElement).dataset.view;
      packageList?.classList.toggle('list-view', view === 'list');
    });
  });

  // Clear
  clearSearchBtn?.addEventListener('click', () => {
    if (searchInput) searchInput.value = '';
    filterPackages();
  });

  filterPackages();
  
  // Copy to clipboard
  document.querySelectorAll('.copy-btn').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      e.preventDefault();
      e.stopPropagation();
      
      const copyText = (btn as HTMLElement).dataset.copy;
      if (!copyText) return;
      
      try {
        await navigator.clipboard.writeText(copyText);
        
        const copyIcon = btn.querySelector('.copy-icon') as HTMLElement;
        const checkIcon = btn.querySelector('.check-icon') as HTMLElement;
        
        if (copyIcon && checkIcon) {
          copyIcon.style.display = 'none';
          checkIcon.style.display = 'block';
          btn.classList.add('copied');
          
          setTimeout(() => {
            copyIcon.style.display = 'block';
            checkIcon.style.display = 'none';
            btn.classList.remove('copied');
          }, 2000);
        }
      } catch (err) {
        console.error('Failed to copy:', err);
      }
    });
  });
</script>
